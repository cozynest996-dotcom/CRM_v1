# WhatsApp ç”¨æˆ·éš”ç¦»åŠŸèƒ½å®ç°

## æ¦‚è¿°

æœ¬ç³»ç»Ÿç°å·²å®ç°æ¯ä¸ªè®¢é˜…ç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„ WhatsApp ä¼šè¯ï¼Œç¡®ä¿æ¶ˆæ¯éšç§å’Œå®‰å…¨ã€‚æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„ WhatsApp è¿æ¥ã€äºŒç»´ç å’Œæ¶ˆæ¯è·¯ç”±ã€‚

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. WhatsApp Gateway æ”¹è¿› (`whatsapp_gateway/index.js`)

**æ ¸å¿ƒå˜åŒ–ï¼š**
- ä»å•ä¸€å…¨å±€å®¢æˆ·ç«¯æ”¹ä¸ºå¤šç”¨æˆ·å®¢æˆ·ç«¯ç®¡ç†
- æ¯ä¸ªç”¨æˆ· ID å¯¹åº”ç‹¬ç«‹çš„ WhatsApp å®¢æˆ·ç«¯å®ä¾‹
- ç‹¬ç«‹çš„ä¼šè¯å­˜å‚¨ï¼ˆä½¿ç”¨ `LocalAuth({ clientId: 'user_${userId}' })`ï¼‰

**å…³é”®åŠŸèƒ½ï¼š**
```javascript
// å¤šç”¨æˆ·å®¢æˆ·ç«¯æ˜ å°„
const clients = {}; // userId -> { client, ready, qr, needQR }

// ä¸ºæ¯ä¸ªç”¨æˆ·åˆå§‹åŒ–ç‹¬ç«‹å®¢æˆ·ç«¯
function initClientForUser(userId) {
  const client = new Client({
    authStrategy: new LocalAuth({ clientId: `user_${userId}` })
  });
  // ç‹¬ç«‹çš„äº‹ä»¶ç›‘å¬å™¨
  // ç‹¬ç«‹çš„æ¶ˆæ¯å¤„ç†
  // ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†
}
```

**API æ›´æ–°ï¼š**
- `/status?user_id=123` - è·å–ç‰¹å®šç”¨æˆ·çš„è¿æ¥çŠ¶æ€
- `/qr?user_id=123` - è·å–ç‰¹å®šç”¨æˆ·çš„äºŒç»´ç 
- `/send` - éœ€è¦ `user_id` å‚æ•°ï¼Œä½¿ç”¨å¯¹åº”ç”¨æˆ·çš„å®¢æˆ·ç«¯å‘é€
- `/logout` - éœ€è¦ `user_id` å‚æ•°ï¼Œæ–­å¼€ç‰¹å®šç”¨æˆ·è¿æ¥

### 2. åç«¯æœåŠ¡æ”¹è¿›

**WhatsApp ä¼šè¯ç®¡ç† (`backend/app/routers/settings.py`):**
- `GET /api/settings/whatsapp/session` - è·å–å½“å‰ç”¨æˆ·çš„ä¼šè¯çŠ¶æ€
- `POST /api/settings/whatsapp/session` - åˆ›å»º/è·å–ç”¨æˆ·ä¼šè¯å¹¶åˆå§‹åŒ– Gateway
- `POST /api/settings/whatsapp/session/update` - Gateway å›è°ƒæ›´æ–°ä¼šè¯çŠ¶æ€

**æ¶ˆæ¯å‘é€æ›´æ–° (`backend/app/services/whatsapp.py`):**
- æ‰€æœ‰å‘é€æ¶ˆæ¯çš„è¯·æ±‚ç°åœ¨åŒ…å« `user_id`
- ç¡®ä¿æ¶ˆæ¯é€šè¿‡æ­£ç¡®ç”¨æˆ·çš„ WhatsApp å®¢æˆ·ç«¯å‘é€

**æ•°æ®åº“æ¨¡å‹ (`backend/app/db/models.py`):**
```python
class WhatsAppSession(Base):
    __tablename__ = "whatsapp_sessions"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    session_key = Column(String, nullable=False, unique=True)
    qr = Column(Text, nullable=True)
    connected = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### 3. å‰ç«¯ UI æ”¹è¿› (`frontend/pages/settings-new.tsx`)

**æ–°çš„ç”¨æˆ·ä½“éªŒï¼š**
- ç§»é™¤å…¨å±€ WhatsApp çŠ¶æ€æ˜¾ç¤º
- ä¸“æ³¨äºå½“å‰ç™»å½•ç”¨æˆ·çš„ä¸ªäºº WhatsApp ä¼šè¯
- æ¸…æ™°çš„è¿æ¥/æ–­å¼€æµç¨‹
- ç”¨æˆ·ä¸“å±äºŒç»´ç æ˜¾ç¤º

**ç”¨æˆ·æµç¨‹ï¼š**
1. ç”¨æˆ·ç™»å½•åè¿›å…¥è®¾ç½®é¡µé¢
2. ç‚¹å‡»"è·å–æˆ‘çš„äºŒç»´ç "
3. ç³»ç»Ÿä¸ºè¯¥ç”¨æˆ·ç”Ÿæˆä¸“å±äºŒç»´ç 
4. ç”¨æˆ·æ‰«æåå»ºç«‹ç‹¬ç«‹çš„ WhatsApp è¿æ¥
5. è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ¶ˆæ¯éƒ½é€šè¿‡å…¶ä¸“å±è¿æ¥å¤„ç†

## ğŸ” éšç§å’Œå®‰å…¨ç‰¹æ€§

### 1. ä¼šè¯éš”ç¦»
- æ¯ä¸ªç”¨æˆ·çš„ WhatsApp ä¼šè¯å®Œå…¨ç‹¬ç«‹
- ä¸åŒç”¨æˆ·æ— æ³•è®¿é—®å½¼æ­¤çš„æ¶ˆæ¯
- ç‹¬ç«‹çš„è®¤è¯çŠ¶æ€å’Œè¿æ¥ç®¡ç†

### 2. æ•°æ®éš”ç¦»
- æ¶ˆæ¯è·¯ç”±åŸºäºç”¨æˆ· ID
- å®¢æˆ·ä¿¡æ¯ä¸å¯¹åº”ç”¨æˆ·å…³è”
- ä¼šè¯æ•°æ®æŒ‰ç”¨æˆ·å­˜å‚¨

### 3. æƒé™æ§åˆ¶
- API ç«¯ç‚¹éœ€è¦ç”¨æˆ·è®¤è¯
- ç”¨æˆ·åªèƒ½ç®¡ç†è‡ªå·±çš„ WhatsApp ä¼šè¯
- å‰ç«¯ UI åŸºäºç”¨æˆ·ç™»å½•çŠ¶æ€æ˜¾ç¤º

## ğŸ“± ä½¿ç”¨æ–¹å¼

### å¯¹äºç”¨æˆ·ï¼š
1. **ç™»å½•è´¦æˆ·** â†’ è¿›å…¥è®¾ç½®é¡µé¢
2. **ç‚¹å‡»"è·å–æˆ‘çš„äºŒç»´ç "** â†’ ç³»ç»Ÿç”Ÿæˆä¸“å±äºŒç»´ç 
3. **æ‰«æäºŒç»´ç ** â†’ ä½¿ç”¨ WhatsApp æ‰«æè¿æ¥
4. **å¼€å§‹ä½¿ç”¨** â†’ ç‹¬ç«‹çš„æ¶ˆæ¯æ”¶å‘

### å¯¹äºå¼€å‘è€…ï¼š
```javascript
// å‘é€æ¶ˆæ¯æ—¶éœ€è¦åŒ…å«ç”¨æˆ·ID
const response = await fetch('/api/messages/send', {
  method: 'POST',
  body: JSON.stringify({
    customer_id: 123,
    content: "æ¶ˆæ¯å†…å®¹",
    user_id: currentUser.id  // å…³é”®ï¼šç”¨æˆ·ID
  })
});
```

## ğŸ§ª æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ç”¨æˆ·éš”ç¦»åŠŸèƒ½ï¼š
```bash
python test_whatsapp_isolation.py
```

æµ‹è¯•è¦†ç›–ï¼š
- ç”¨æˆ·ç‰¹å®šçš„äºŒç»´ç ç”Ÿæˆ
- ç”¨æˆ·ç‰¹å®šçš„è¿æ¥çŠ¶æ€
- ç”¨æˆ·ç‰¹å®šçš„æ¶ˆæ¯å‘é€
- åç«¯ä¼šè¯ç®¡ç†ç«¯ç‚¹

## ğŸ”„ è¿ç§»è¯´æ˜

### ä»æ—§ç³»ç»Ÿè¿ç§»ï¼š
1. **æ•°æ®è¿ç§»**ï¼šç°æœ‰æ¶ˆæ¯å’Œå®¢æˆ·éœ€è¦å…³è”åˆ°å¯¹åº”ç”¨æˆ·
2. **é‡æ–°è¿æ¥**ï¼šç”¨æˆ·éœ€è¦é‡æ–°æ‰«æäºŒç»´ç å»ºç«‹ä¸ªäººè¿æ¥
3. **æ¸…ç†**ï¼šåˆ é™¤æ—§çš„å…¨å±€ä¼šè¯æ•°æ®

### å…¼å®¹æ€§ï¼š
- ä¿æŒç°æœ‰ API ç»“æ„ï¼Œä»…æ·»åŠ  `user_id` å‚æ•°
- å‰ç«¯é€æ­¥è¿ç§»ï¼Œæ”¯æŒæ–°æ—§é¡µé¢å¹¶å­˜
- Gateway æ”¯æŒå‘åå…¼å®¹ï¼ˆå¦‚æœæœªæä¾› user_id ä¼šæŠ¥é”™ï¼‰

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. ç”¨æˆ·ç®¡ç†
- ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½æœ‰å”¯ä¸€çš„ ID
- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„ä¼šè¯
- ç›‘æ§è¿æ¥çŠ¶æ€å’Œå¼‚å¸¸

### 2. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯
- å®šæœŸæ¸…ç†æ–­å¼€çš„è¿æ¥
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### 3. é”™è¯¯å¤„ç†
- ä¼˜é›…å¤„ç†ç”¨æˆ·å®¢æˆ·ç«¯æ–­å¼€
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿æ•°æ®åº“è¿ç§»**ï¼šè¿è¡Œ `WhatsAppSession` è¡¨åˆ›å»ºè¿ç§»
2. **é‡å¯æœåŠ¡**ï¼šé‡å¯ WhatsApp Gateway å’Œåç«¯æœåŠ¡
3. **ç”¨æˆ·é€šçŸ¥**ï¼šé€šçŸ¥ç”¨æˆ·éœ€è¦é‡æ–°è®¾ç½® WhatsApp è¿æ¥
4. **ç›‘æ§**ï¼šå¯†åˆ‡ç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·åé¦ˆ

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ï¼š
1. **ç”¨æˆ·æ— æ³•è·å–äºŒç»´ç **
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
   - ç¡®è®¤ Gateway æœåŠ¡è¿è¡Œæ­£å¸¸
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **æ¶ˆæ¯å‘é€å¤±è´¥**
   - ç¡®è®¤ç”¨æˆ· WhatsApp å·²è¿æ¥
   - æ£€æŸ¥ user_id æ˜¯å¦æ­£ç¡®ä¼ é€’
   - æŸ¥çœ‹ Gateway æ—¥å¿—

3. **ä¼šè¯æ–­å¼€**
   - æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
   - ç¡®è®¤ WhatsApp Web æƒé™
   - é‡æ–°æ‰«æäºŒç»´ç 

---

**å®ç°å®Œæˆï¼** ğŸ‰

ç°åœ¨æ¯ä¸ªè®¢é˜…ç”¨æˆ·éƒ½æ‹¥æœ‰ç‹¬ç«‹ã€ç§å¯†çš„ WhatsApp é›†æˆï¼Œç¡®ä¿æ¶ˆæ¯å®‰å…¨å’Œç”¨æˆ·éšç§ã€‚
