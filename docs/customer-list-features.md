# 客户列表新功能使用指南

## 概述
客户列表现已支持新建客户和导出CSV功能，方便用户管理和导出客户数据。

## 1. 新建客户

### 使用步骤
1. 点击客户列表页面顶部的 **"+ 新建客户"** 按钮
2. 在弹出的模态框中填写客户信息：
   - **姓名*** (必填)
   - **电话*** (必填)
   - 邮箱 (可选)
   - 阶段 (可选 - 从下拉列表选择)
   - 状态 (可选 - 默认为"活跃")
3. 如需添加自定义字段，点击 **"+ 添加字段"** 按钮
4. 点击 **"💾 创建客户"** 按钮保存

### 功能特点
- ✅ 自动验证必填字段
- ✅ 检查电话号码重复（同一用户下）
- ✅ 支持无限自定义字段
- ✅ 自动关联到当前登录用户
- ✅ 创建成功后自动刷新列表并跳转到第一页

### API接口
```
POST /api/customers
Authorization: Bearer {token}

请求体示例:
{
  "name": "张三",
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "status": "active",
  "stage_id": "1",
  "custom_fields": {
    "company": "ABC公司",
    "note": "重要客户"
  }
}
```

## 2. 导出CSV

### 使用步骤
1. (可选) 使用搜索和筛选功能缩小客户范围
2. 点击 **"📊 导出CSV"** 按钮
3. 浏览器会自动下载CSV文件

### 功能特点
- ✅ 导出当前搜索和筛选条件下的所有客户
- ✅ 包含当前可见的所有列（包括自定义列）
- ✅ 自动处理自定义字段
- ✅ 文件名包含日期（如：`customers_20251020.csv`）
- ✅ 支持大量数据的流式导出
- ✅ 时间戳自动格式化为ISO格式

### 导出字段
默认导出字段包括：
- id
- name (姓名)
- phone (电话)
- email (邮箱)
- telegram_chat_id (Telegram ID)
- status (状态)
- stage_id (阶段ID)
- last_timestamp (最后联系时间)
- updated_at (更新时间)

如果在列设置中添加了自定义列，这些列也会被导出。

### API接口
```
GET /api/customers/export-csv?search={搜索词}&filters={过滤条件}&fields={字段列表}
Authorization: Bearer {token}

参数说明:
- search: 搜索词（可选）
- filters: JSON格式的过滤条件（可选）
- fields: 逗号分隔的字段列表（可选，默认为标准字段）

示例:
GET /api/customers/export-csv?search=张三&filters={"status":"active"}
```

## 3. 技术细节

### 前端实现
- 使用React Hooks管理状态
- 模态框支持响应式布局
- 表单验证在提交前进行
- 使用Fetch API下载文件

### 后端实现
- FastAPI路由处理
- SQLAlchemy ORM查询
- 流式CSV生成，内存高效
- 支持大数据量导出

### 安全性
- 所有操作都需要用户认证
- 用户只能创建和导出自己的客户数据
- 电话号码重复检查限定在用户范围内

## 4. 常见问题

**Q: 导出CSV时会包含所有客户吗？**
A: 不会。导出会遵循当前的搜索和筛选条件。如果没有设置任何筛选，则会导出所有客户。

**Q: 可以自定义导出的列吗？**
A: 可以。在列设置中配置可见列，导出时会包含所有可见列。

**Q: 创建客户时电话号码已存在怎么办？**
A: 系统会提示"Phone already exists"，需要使用不同的电话号码。

**Q: 自定义字段在CSV中如何显示？**
A: 自定义字段会作为独立的列，列名为去掉"custom_fields."前缀的字段名。

**Q: 导出的CSV文件编码是什么？**
A: UTF-8编码，在Excel中打开可能需要选择正确的编码。

## 5. 未来改进计划

- [ ] 支持批量导入客户（CSV上传）
- [ ] 支持导出为Excel格式
- [ ] 支持选择性导出（勾选特定客户）
- [ ] 支持导出模板定制
- [ ] 添加导出历史记录

