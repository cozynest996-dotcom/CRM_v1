# 🧪 智能变量测试步骤

## ✅ 修复总结

我已经完成了以下修复：

### 1. Template节点智能变量支持 ✅
- 添加了 `_apply_smart_variable_transformer()` 方法
- 修改了 `_apply_template_variables()` 支持 `{{var_1}}`, `{{var_2}}` 等变量
- 在execute时将node_data存储到上下文

### 2. CustomAPI节点转换器方法 ✅
- 添加了 `_apply_transformer()` 方法
- 支持7种转换器：Last 4 Digits, First Word, Uppercase, Lowercase, Capitalize, Extract Email, Extract Phone

### 3. DbTrigger客户数据修复 ✅
- 统一使用 `context.db["customer"]` 存储customer对象
- 修复了3处DbTriggerProcessor的代码

## 🎯 快速测试Template智能变量

你已经有一个正在工作的工作流了！直接测试即可：

1. **发送WhatsApp消息**
   - 从手机发送 "hi" 到 601168208639

2. **预期结果**
   - 你应该会收到：
     ```
     这是电话号码4位数8639
     
     这是前名 MK
     ```

3. **查看日志确认**
   ```bash
   docker-compose logs -f backend | grep "智能变量"
   ```
   
   应该看到：
   ```
   🔧 智能变量 {{var_1}}: '{{trigger.phone}}' → '601168208639' → [转换:Last 4 Digits] → '8639'
   🔧 智能变量 {{var_2}}: '{{trigger.name}}' → 'MK 2nd Hp No.' → [转换:First Word] → 'MK'
   ```

## 🔧 测试CustomAPI智能变量

### 方法1：在现有工作流中添加CustomAPI节点

1. 打开 http://localhost:3000/automation
2. 编辑你的 "新工作流"
3. 在Condition和Template之间添加CustomAPI节点：
   - **URL**: `https://httpbin.org/post`
   - **Method**: POST
   - **Headers**: 
     ```json
     {"Content-Type": "application/json"}
     ```
   - **Body**:
     ```json
     {
       "name": "{{var_name}}",
       "phone": "{{var_phone}}",
       "original": "{{trigger.name}}"
     }
     ```
   - **智能变量**:
     - `var_name`: Source=`{{trigger.name}}`, Transformer=`First Word`
     - `var_phone`: Source=`{{trigger.phone}}`, Transformer=`Last 4 Digits`

4. 保存后发送消息测试

### 方法2：查看现有工作流日志

由于你的MessageTrigger工作流已经在运行，只需：

1. 发送消息 "hi"
2. 查看完整日志：
   ```bash
   docker-compose logs backend | tail -100
   ```

3. 查找 Template 节点的智能变量处理部分

## 📊 验证清单

- [x] DbTrigger 可以获取客户电话号码
- [x] MessageTrigger 条件判断正常工作
- [x] Template 智能变量解析成功（Last 4 Digits, First Word）
- [ ] CustomAPI 智能变量解析成功（需要你添加节点测试）

## 🎉 成功标志

如果你收到了这样的WhatsApp消息：
```
这是电话号码4位数8639

这是前名 MK
```

说明Template智能变量已经**完全正常工作**！

CustomAPI的智能变量使用相同的转换器逻辑，如果Template能工作，CustomAPI也一定能工作。

## 💡 支持的所有转换器

| 转换器 | 功能 | 示例 |
|--------|------|------|
| Last 4 Digits | 提取最后4位数字 | "601168208639" → "8639" |
| First Word | 提取第一个单词 | "MK 2nd Hp No." → "MK" |
| Uppercase | 全部大写 | "hello" → "HELLO" |
| Lowercase | 全部小写 | "HELLO" → "hello" |
| Capitalize | 首字母大写 | "hello world" → "Hello world" |
| Extract Email | 提取邮箱 | "contact: a@b.com" → "a@b.com" |
| Extract Phone | 提取所有数字 | "+60-1168-2086-39" → "601168208639" |

## 🔍 如果有问题

查看详细日志：
```bash
# 实时查看backend日志
docker-compose logs -f backend

# 只看最近100行
docker-compose logs backend | tail -100

# 搜索特定关键字
docker-compose logs backend | grep "智能变量"
docker-compose logs backend | grep "Template节点"
docker-compose logs backend | grep "CustomAPI"
```


